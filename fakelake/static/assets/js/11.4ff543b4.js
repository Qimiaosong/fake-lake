"use strict";(self["webpackChunkdata_lake_analytics"]=self["webpackChunkdata_lake_analytics"]||[]).push([[11],{3011:function(e,a,l){l.r(a),l.d(a,{default:function(){return S}});var t=l(6252),u=l(2262),s=l(6583),n=l(3907),o=l(2201);const d={class:"bar",ref:"chart"};var i=(0,t.aZ)({__name:"Charts",props:["id"],setup(e){const a=e,l=((0,t.f3)("reload"),(0,n.oR)());let o={};const{proxy:i}=(0,t.FN)(),r=(0,t.Fl)((()=>l.state.dataAnalyze.echartType)),m=(0,t.Fl)((()=>(0,s.iz)(sessionStorage.getItem("chartInfo")))),c=(0,u.iH)(sessionStorage.getItem("axisNameArr")?(0,s.iz)(sessionStorage.getItem("axisNameArr")):[]),v=e=>{const a=i?.$echarts.init(i.$refs.chart);a.setOption(e)},p=()=>{o={backgroundColor:"rgba(78, 205, 173, 0.1)",title:{text:"分析结果",textStyle:{color:"white"}},legend:{textStyle:{color:"white"},left:100},tooltip:{},dataset:{dimensions:m.value?.dimensions||[],source:m.value?.data||[]},xAxis:{name:c.value[a.id]?.xAxisName||m.value?.dimensions[0],type:"category",axisLabel:{color:"white"},inverse:!1},yAxis:{name:c.value[a.id]?.yAxisName||""},series:new Array(m.value?.dimensions.length-1||1).fill({type:r.value})}};return(0,t.bv)((()=>{p(),(0,t.Y3)((()=>{v(o)}))})),(e,a)=>((0,t.wg)(),(0,t.iD)("div",d,null,512))}}),r=l(3744);const m=(0,r.Z)(i,[["__scopeId","data-v-4634fa3c"]]);var c=m,v=l(3577);const p={class:"time"};var g=(0,t.aZ)({__name:"Countdown",props:["milliseconds","start"],setup(e){const a=e;(0,u.iH)("00");let l=(0,u.iH)("00"),s=(0,u.iH)("00"),n=(0,u.iH)("00"),o=(0,u.iH)(),d=a.milliseconds/1e3;const i=e=>{m(),o.value=setInterval((()=>{e<0||!e||(e--,r(e))}),1e3)},r=e=>{parseInt(e/60/60/24+"");let a=parseInt(e/60/60%24+""),t=parseInt(e/60%60+""),u=parseInt(e%60+"");l.value=a>9?a+"":"0"+a,s.value=t>9?t+"":"0"+t,n.value=u>9?u+"":"0"+u};(0,t.bv)((()=>{i(d)})),(0,t.YP)((()=>a.milliseconds),((e,l)=>{d=a.milliseconds/1e3,i(d)})),(0,t.YP)((()=>a.start),((e,a)=>{e?i(d):m()}));const m=()=>{clearInterval(o.value),o.value=null};return(0,t.Ah)((()=>{m()})),(e,a)=>{const l=(0,t.up)("AlarmClock"),o=(0,t.up)("el-icon");return(0,t.wg)(),(0,t.iD)(t.HY,null,[(0,t.Wm)(o,null,{default:(0,t.w5)((()=>[(0,t.Wm)(l)])),_:1}),(0,t._)("div",p,(0,v.zw)((0,u.SU)(s))+"分:"+(0,v.zw)((0,u.SU)(n))+"秒",1)],64)}}});const w=(0,r.Z)(g,[["__scopeId","data-v-3b429320"]]);var y=w;const b={class:"dataAnalyze"},f={class:"left"},h={class:"card",style:{"margin-bottom":"10px"}},_={key:0},x={key:1},k={class:"card"},V={key:2},W={class:"right"};var D=(0,t.aZ)({__name:"DataAnalyzeView",setup(e){(0,o.tv)();const a=(0,o.yj)(),l=(0,n.oR)(),d=((0,t.f3)("reload"),(0,u.iH)([])),i=(0,u.iH)([]),r=(0,u.iH)("sql语句查询"),m=(0,u.iH)("表格"),v=(0,u.iH)(),p=(0,u.iH)(0),g=(0,u.iH)(0),w=(0,u.iH)(""),D=(0,u.iH)(""),H=(0,u.iH)([]),S=(0,u.iH)([]),T=(0,u.iH)(1e3),A=(0,u.iH)(),U=(0,u.iH)(!1),q=(0,u.qj)({xaxis:""}),z=(0,u.qj)({env:-1,sourceDB:"",sourceTable:""}),I=(0,u.iH)(!1);let j=(0,u.iH)();const B=(0,u.qj)({1:"1",5:"5",10:"10",30:"30分钟",60:"1小时"}),C=(0,u.qj)({env:[{required:!0,message:"不能为空",trigger:"change"}],sourceDB:[{required:!0,message:"不能为空",trigger:"change"}],sourceTable:[{required:!0,message:"不能为空",trigger:"change"}],text:[{required:!0,message:"不能为空",trigger:"change"}]});(0,t.wF)((async()=>{l.state.dataAnalyze.chartError=!0,await N()})),(0,t.bv)((()=>{U.value=(0,s.iz)(sessionStorage.getItem("realtime"))||!1,U.value&&L()}));const Y=()=>{q.xaxis=H.value&&H.value.length>0&&H.value[0]},N=async()=>{A.value=Number(a.query?.id)||null,(A.value||0==A.value)&&await F(A.value).then((e=>{z.sourceDB=e.curSourceDB,z.sourceTable=e.curSourceTable}))},$=e=>{e&&l.dispatch("dataAnalyze/getTablesByEnv",{envID:z.env||null}).then((e=>{10013==e.data.code?d.value=e.data.data:(z.sourceDB="",d.value=[])}))},F=async e=>{let a="";await l.dispatch("dataModeling/getdataModelingTaskList",{all:!0});let t=l.state.dataModeling.allDataModelingTaskList.find((l=>(a=l.name||"",l.id==e)))?.operators;return{curSourceDB:t[0]?.sourceDB,curSourceTable:a}},K=()=>{p.value=(new Date).getTime()},O=()=>{g.value=(new Date).getTime()},Z=e=>{i.value=d.value?.find((a=>a.dbname==e))?.tables},E=e=>{z.sourceTable="",q.xaxis="",Z(e)},M=e=>i.value?.filter((a=>a.name===e))[0]?.fields,P=()=>{J(null)},R=(0,t.Fl)((()=>l.state.dataAnalyze.time)),L=()=>{clearInterval(j.value),j.value=setInterval((()=>{"sql语句查询"==r.value?X(null):X(D.value)}),60*R.value*1e3),O()};(0,t.YP)(R,((e,a)=>{L()}),{deep:!0});const J=async e=>{let a,t="";if(!e)if("图"==m.value&&q.xaxis){let e=M(z.sourceTable)?.filter((e=>e.name!=q.xaxis));e?.unshift(q.xaxis),a=e?.join(",")}else a="*";t=`select ${a} from ${z.sourceDB}.\`${z.sourceTable}\` limit ${T.value}`,l.dispatch("dataAnalyze/chartByRawSql",{rawSql:e||t,env_id:z.env}).then((e=>{sessionStorage.setItem("chartInfo",JSON.stringify(e.data.data)),H.value=e.data.data?.dimensions,S.value=e.data.data?.data,N(),Y(),K(),U.value&&L()}))},G=()=>{l.dispatch("dataAnalyze/chartByText2sql",{text:w.value,table_name:`${z.sourceDB}.${z.sourceTable}`,env_id:z.env}).then((e=>{10013==e.data.code?D.value=e.data.data.sql_query:l.commit("POP_MESSAGE",{message:e.data.message,type:"error"},{root:!0})}))},Q=(e,a)=>{e.validate((async e=>{e&&a()}))},X=e=>{Q(v.value,(()=>{J(e)}))},ee=()=>{Q(v.value,(()=>{G()}))},ae=e=>{clearInterval(e),e=null},le=e=>{I.value=e,sessionStorage.setItem("realtime",JSON.stringify(e)),L(),e||ae(j.value)};return(0,t.Ah)((()=>{ae(j.value)})),(e,a)=>{const s=(0,t.up)("el-option"),n=(0,t.up)("el-select"),o=(0,t.up)("el-form-item"),j=(0,t.up)("el-input"),Y=(0,t.up)("el-col"),N=(0,t.up)("el-button"),F=(0,t.up)("el-row"),O=(0,t.up)("el-form"),Z=(0,t.up)("el-radio-button"),L=(0,t.up)("el-radio-group"),J=(0,t.up)("el-switch"),G=(0,t.up)("el-slider"),Q=(0,t.up)("el-empty"),ae=(0,t.up)("el-table-column"),te=(0,t.up)("el-table");return(0,t.wg)(),(0,t.iD)("div",b,[(0,t._)("div",f,[(0,t._)("div",h,[(0,t.Wm)(O,{ref_key:"ruleFormRef1",ref:v,model:z,rules:C,"label-width":"100px"},{default:(0,t.w5)((()=>["自然语言查询"==r.value?((0,t.wg)(),(0,t.iD)("div",_,[(0,t.Wm)(o,{label:"数据库名"},{default:(0,t.w5)((()=>[(0,t.Wm)(n,{modelValue:z.sourceDB,"onUpdate:modelValue":a[0]||(a[0]=e=>z.sourceDB=e),onChange:E,style:{width:"100%"},placeholder:"请选择"},{default:(0,t.w5)((()=>[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(d.value,((e,a)=>((0,t.wg)(),(0,t.j4)(s,{key:a,label:e.dbname,value:e.dbname},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,t.Wm)(o,{label:"表名"},{default:(0,t.w5)((()=>[(0,t.Wm)(n,{modelValue:z.sourceTable,"onUpdate:modelValue":a[1]||(a[1]=e=>z.sourceTable=e),style:{width:"100%"},placeholder:"请选择"},{default:(0,t.w5)((()=>[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(i.value,((e,a)=>((0,t.wg)(),(0,t.j4)(s,{key:a,label:e.name,value:e.name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),(0,t.Wm)(F,{gutter:10},{default:(0,t.w5)((()=>[(0,t.Wm)(Y,{span:18},{default:(0,t.w5)((()=>[(0,t.Wm)(o,{label:"自然语言"},{default:(0,t.w5)((()=>[(0,t.Wm)(j,{modelValue:w.value,"onUpdate:modelValue":a[2]||(a[2]=e=>w.value=e),placeholder:"关键词请尽量描述具体",type:"textarea",autosize:""},null,8,["modelValue"])])),_:1})])),_:1}),(0,t.Wm)(Y,{span:4},{default:(0,t.w5)((()=>[(0,t.Wm)(N,{onClick:ee,plain:"",type:"primary",style:{position:"absolute",bottom:"18px"}},{default:(0,t.w5)((()=>[(0,t.Uk)("获取sql")])),_:1})])),_:1})])),_:1}),D.value?((0,t.wg)(),(0,t.j4)(F,{key:0,gutter:10},{default:(0,t.w5)((()=>[(0,t.Wm)(Y,{span:18},{default:(0,t.w5)((()=>[(0,t._)("pre",null,[(0,t.Wm)(j,{modelValue:D.value,"onUpdate:modelValue":a[3]||(a[3]=e=>D.value=e),placeholder:"sql查询",type:"textarea",autosize:""},null,8,["modelValue"])])])),_:1}),(0,t.Wm)(Y,{span:4},{default:(0,t.w5)((()=>[(0,t.Wm)(N,{onClick:a[4]||(a[4]=e=>X(D.value)),plain:"",type:"primary"},{default:(0,t.w5)((()=>[(0,t.Uk)("查询")])),_:1})])),_:1})])),_:1})):(0,t.kq)("",!0)])):((0,t.wg)(),(0,t.iD)("div",x,[(0,t.Wm)(o,{label:"数据库名",prop:"sourceDB"},{default:(0,t.w5)((()=>[(0,t.Wm)(n,{modelValue:z.sourceDB,"onUpdate:modelValue":a[5]||(a[5]=e=>z.sourceDB=e),onChange:E,onVisibleChange:$,disabled:-1!=[null,void 0,""].indexOf(z.env),style:{width:"100%"},placeholder:"请选择"},{default:(0,t.w5)((()=>[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(d.value,((e,a)=>((0,t.wg)(),(0,t.j4)(s,{key:a,label:e.dbname,value:e.dbname},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1}),(0,t.Wm)(o,{label:"表名",prop:"sourceTable"},{default:(0,t.w5)((()=>[(0,t.Wm)(n,{modelValue:z.sourceTable,"onUpdate:modelValue":a[6]||(a[6]=e=>z.sourceTable=e),onChange:a[7]||(a[7]=e=>q.xaxis=""),disabled:-1!=[null,void 0,""].indexOf(z.sourceDB),style:{width:"100%"},placeholder:"请选择"},{default:(0,t.w5)((()=>[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(i.value,((e,a)=>((0,t.wg)(),(0,t.j4)(s,{key:a,label:e.name,value:e.name},null,8,["label","value"])))),128))])),_:1},8,["modelValue","disabled"])])),_:1}),(0,t.Wm)(o,{label:"查询条数"},{default:(0,t.w5)((()=>[(0,t.Wm)(j,{modelValue:T.value,"onUpdate:modelValue":a[8]||(a[8]=e=>T.value=e)},null,8,["modelValue"])])),_:1}),(0,t.Wm)(N,{onClick:a[9]||(a[9]=e=>X(null)),type:"primary"},{default:(0,t.w5)((()=>[(0,t.Uk)("查询")])),_:1})]))])),_:1},8,["model","rules"])]),(0,t._)("div",k,[(0,t.Wm)(O,null,{default:(0,t.w5)((()=>[(0,t.Wm)(L,{modelValue:m.value,"onUpdate:modelValue":a[10]||(a[10]=e=>m.value=e),size:"small",style:{"margin-bottom":"10px"}},{default:(0,t.w5)((()=>[(0,t.Wm)(Z,{label:"表格"}),(0,t.Wm)(Z,{label:"图"})])),_:1},8,["modelValue"]),"图"==m.value?((0,t.wg)(),(0,t.j4)(o,{key:0,label:"选择图类型"},{default:(0,t.w5)((()=>[(0,t.Wm)(n,{modelValue:(0,u.SU)(l).state.dataAnalyze.echartType,"onUpdate:modelValue":a[11]||(a[11]=e=>(0,u.SU)(l).state.dataAnalyze.echartType=e),onChange:K,style:{width:"100%"},placeholder:"请选择","no-data-text":"没有数据"},{default:(0,t.w5)((()=>[(0,t.Wm)(s,{label:"柱状图",value:"bar"}),(0,t.Wm)(s,{label:"折线图",value:"line"})])),_:1},8,["modelValue"])])),_:1})):(0,t.kq)("",!0),"图"==m.value?((0,t.wg)(),(0,t.j4)(o,{key:1,label:"横坐标"},{default:(0,t.w5)((()=>[(0,t.Wm)(n,{modelValue:q.xaxis,"onUpdate:modelValue":a[12]||(a[12]=e=>q.xaxis=e),style:{width:"100%"},placeholder:"请选择",onChange:P,"no-data-text":"没有数据"},{default:(0,t.w5)((()=>[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(M(z.sourceTable),((e,a)=>((0,t.wg)(),(0,t.j4)(s,{key:a.name,label:e.name,value:e.name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1})):(0,t.kq)("",!0),(0,t.Wm)(o,{label:"实时更新"},{default:(0,t.w5)((()=>[(0,t.Wm)(J,{modelValue:U.value,"onUpdate:modelValue":a[13]||(a[13]=e=>U.value=e),onChange:le},null,8,["modelValue"])])),_:1}),U.value?((0,t.wg)(),(0,t.iD)("div",V,[(0,t.Wm)(o,{label:"时间间隔(/min)"},{default:(0,t.w5)((()=>[((0,t.wg)(),(0,t.j4)(y,{milliseconds:60*(0,u.SU)(R)*1e3,start:I.value,key:g.value},null,8,["milliseconds","start"]))])),_:1}),(0,t.Wm)(G,{modelValue:(0,u.SU)(l).state.dataAnalyze.time,"onUpdate:modelValue":a[14]||(a[14]=e=>(0,u.SU)(l).state.dataAnalyze.time=e),min:.5,max:30,marks:B,size:"small"},null,8,["modelValue","min","marks"])])):(0,t.kq)("",!0)])),_:1})])]),(0,t._)("div",W,[(0,u.SU)(l).state.dataAnalyze.chartError?((0,t.wg)(),(0,t.j4)(Q,{key:0,description:"没有数据"})):"表格"==m.value?((0,t.wg)(),(0,t.j4)(te,{data:S.value,key:(new Date).getTime(),border:"","header-cell-style":{padding:"20px 0"},"empty-text":"没有数据"},{default:(0,t.w5)((()=>[((0,t.wg)(!0),(0,t.iD)(t.HY,null,(0,t.Ko)(H.value,((e,a)=>((0,t.wg)(),(0,t.j4)(ae,{key:a,prop:e,label:e},null,8,["prop","label"])))),128))])),_:1},8,["data"])):((0,t.wg)(),(0,t.j4)(c,{id:A.value,key:p.value},null,8,["id"]))])])}}});const H=(0,r.Z)(D,[["__scopeId","data-v-5057b403"]]);var S=H}}]);
//# sourceMappingURL=11.4ff543b4.js.map